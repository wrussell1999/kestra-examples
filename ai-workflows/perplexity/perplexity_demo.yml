id: perplexity_demo
namespace: company.team

inputs:
  - id: book
    type: STRING
    displayName: What book did you read recently?
    defaults: The Hunger Games by Suzanne Collins

  - id: chapter
    type: INT
    displayName: What chapter did you just finish?

tasks:
  - id: get_chapter_summary
    type: io.kestra.plugin.perplexity.ChatCompletion
    messages:
      - type: SYSTEM
        content: "You will summarise book chapters in a clear and consise way. Use a mix of paragraphs and bullet points."
      - type: USER
        content: "I am currently reading {{ inputs.book }} and just finished chapter {{ inputs.chapter }}. Please summarise it for me to make sure I followed along correctly."

  - id: convert_to_html
    type: io.kestra.plugin.perplexity.ChatCompletion
    messages:
      - type: SYSTEM
        content: "Convert the book summary into a nicely formatted HTML email. Do not wrap the HTML in markdown. It does not need an introduction, subject or a signature. Also link the search resources at the bottom with bullet points. Use a separate header called Resources to separate the search resources."
      - type: USER
        content: "{{ outputs.get_chapter_summary.rawResponse }}"

  - id: send_summary
    type: io.kestra.plugin.notifications.mail.MailSend
    from: wrussell@kestra.io
    to: wrussell@kestra.io
    username: "{{ kv('G_EMAIL') }}"
    password: "{{ kv('G_APP_PASSWORD') }}"
    host: smtp.gmail.com
    port: 465
    subject: "Book Summary - {{ inputs.book }}: Chapter {{ inputs.chapter }}"
    htmlTextContent: "{{ outputs.convert_to_html.outputText }}"

pluginDefaults:
  - forced: false
    type: io.kestra.plugin.perplexity.ChatCompletion
    values:
      apiKey: "{{ kv('PERPLEXITY_API_KEY') }}"
      model: sonar
      temperature: 0.7
